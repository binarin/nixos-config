---
- hosts: pve
  become: true
  vars:
    zfs_exporter_version: '2.3.4'
    # zfs_exporter_options: '--collector.dataset-snapshot'
    vmagent_remote_write_host: http://192.168.2.2:8428
    vmagent_scrape_config:
      global:
        external_labels:
          host: "{{ inventory_hostname }}"
      scrape_configs:
        - job_name: "node"
          scrape_interval: "10s"
          static_configs:
            - targets: ["127.0.0.1:9100"]
        - job_name: "zfs"
          scrape_interval: "10s"
          static_configs:
            - targets: ["127.0.0.1:9134"]
        - job_name: "vmagent"
          scrape_interval: "10s"
          static_configs:
            - targets: ["127.0.0.1:8429"]

  roles:
    - victoriametrics.cluster.vmagent
    - prometheus.prometheus.node_exporter
    - aroberts.zfs_exporter
  handlers:
    - name: Update initramfs
      listen:
        - update initramfs
        - update initrd
      ansible.builtin.command:
        cmd: >
          update-initramfs -k all -u
  tasks:
    - name: Install some generic linux tools
      package:
        state: present
        name:
          - emacs-nox
          - sysstat
          - iotop
          - net-tools #netstat
          - tmux
          - mosh
    - name: Copy sanoid config
      copy:
        src: "{{ inventory_hostname }}-sanoid.conf"
        dest: /etc/sanoid/sanoid.conf
        mode: '0644'
    - name: Install Clevis with necessary pins/integrations
      notify: update initramfs
      package:
        state: present
        name:
          - clevis
          - clevis-tpm2
          - clevis-initramfs
          - clevis-luks

- hosts: manage_root_ssh_access
  become: true
  tags: ssh
  vars_files:
    ./ssh-public-keys.yaml
  handlers:
    - name: Restart sshd
      listen: restart sshd
      ansible.builtin.service: name=sshd state=reloaded
  tasks:
    - name: Ensure root .ssh directory
      file:
        path: /root/.ssh
        state: directory
        owner: root
        group: root
        mode: "0700"
    - name: Set authorized_keys for root
      template:
        src: authorized_keys.j2
        dest: /root/.ssh/authorized_keys
        owner: root
        group: root
        mode: "0644"
    - name: Clean-up multiple PermitRootLogin lines (just in case)
      notify: restart sshd
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        state: absent
        regexp: '^\s*PermitRootLogin\s+(?!prohibit-password).+'
    - name: Enforce public-key auth for root user
      notify: restart sshd
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        line: "PermitRootLogin prohibit-password"
        regexp: '^(\s|#)*PermitRootLogin'

- hosts: pve
  become: true
  tasks:
    - name: Install packages to use SSH key in tpm 2.0
      package:
        state: present
        name:
          - libtpm2-pkcs11-tools
          - libtpm2-pkcs11-1
    - name: Use SSH key from tpm 2.0 by default
      copy:
        content: |
          Host *
            PKCS11Provider /usr/lib/x86_64-linux-gnu/libtpm2_pkcs11.so.1
        dest: /etc/ssh/ssh_config.d/enable-tpm2-pkcs11.conf
        mode: '0644'
        owner: root


- hosts: bael.lynx-lizard.ts.net
  become: true
  tasks:
    - name: Copy and enable hourly raum->bael backup script
      copy:
        src: backup-raum
        dest: /etc/cron.hourly/backup-raum
        mode: '0755'
        owner: root
        group: root
