# auto-generated via: ncf ci generate
on:
  push:
    branches:
    - master
  pull_request:
    types:
    - opened
    - synchronize
    - reopened
jobs:
  nixos-configuration:
    runs-on: native
    strategy:
      fail-fast: false
      matrix:
        nixosConfiguration:
        - claude-nixos-config
        - demandred
        - devcontainer
        - docker-on-nixos
        - forgejo
        - furfur
        - ishamael
        - iso
        - mail
        - media
        - monitor
        - nix-cache
        - qdevice
    steps:
    - uses: actions/checkout@v4
    - name: unlock git-crypt
      env:
        GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
      run: git crypt unlock <(echo "$GIT_CRYPT_KEY"|base64 -d)
    - run: |-
        nix build "$(pwd)#nixosConfigurations.${{ matrix.nixosConfiguration }}.config.system.build.toplevel" \
          --keep-going \
          -j auto \
          -o "$HOME/.cache/nixos-config/master/nixos-configuration/${{ matrix.nixosConfiguration }}"
  check:
    runs-on: native
    needs:
    - build-all-configurations-job
    steps:
    - uses: actions/checkout@v4
    - name: unlock git-crypt
      env:
        GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
      run: git crypt unlock <(echo "$GIT_CRYPT_KEY"|base64 -d)
    - run: nix flake check
