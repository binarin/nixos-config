# auto-generated via: nix run .#ci-template-generator
jobs:
  check:
    needs:
    - build-all-configurations-job
    runs-on: native
    steps:
    - uses: actions/checkout@v4
    - env:
        GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
      name: unlock git-crypt
      run: |
        git crypt unlock <(echo "$GIT_CRYPT_KEY"|base64 -d)
    - run: |
        nix flake check
  nixos-configuration:
    runs-on: native
    steps:
    - uses: actions/checkout@v4
    - env:
        GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
      name: unlock git-crypt
      run: |
        git crypt unlock <(echo "$GIT_CRYPT_KEY"|base64 -d)
    - run: |
        nix build "$(pwd)#nixosConfigurations.${{ matrix.nixosConfiguration }}.config.system.build.toplevel" \
          --keep-going \
          -j auto \
          -o "$HOME/.cache/nixos-config/master/nixos-configuration/${{ matrix.nixosConfiguration }}"
    strategy:
      fail-fast: false
      matrix:
        nixosConfiguration:
        - demandred
        - devcontainer
        - docker-on-nixos
        - forgejo
        - furfur
        - ishamael
        - iso
        - mail
        - media
        - monitor
        - nix-cache
        - qdevice
on:
  pull_request:
    types:
    - opened
    - synchronize
    - reopened
  push:
    branches:
    - master
