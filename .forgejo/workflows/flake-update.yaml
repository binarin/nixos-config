# auto-generated via: ncf ci generate
on:
  schedule:
  - cron: 13 10 * * Mon
  workflow_dispatch: {}
jobs:
  propose-inputs-update:
    runs-on: native
    steps:
    - uses: actions/checkout@v4
      with:
        ref: master
    - name: unlock git-crypt
      env:
        GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
      run: git crypt unlock <(echo "$GIT_CRYPT_KEY"|base64 -d)
    - name: Update flake inputs
      run: nix flake update
    - name: give autofollow a chance to mess with flake.lock
      run: nix run .#write-flake
    - name: Set git username for commits
      run: 'git config user.name "Automatic Flake Updater" '
    - name: Set git email for commits
      run: git config user.email "flake-updater@binarin.info"
    - name: Commit updates
      run: git commit --allow-empty -am "Bump inputs"
    - name: Build nixosConfiguration.claude-nixos-config
      run: nix run .#ncf -- build nixos claude-nixos-config --no-nom -o temp-result/claude-nixos-config
    - name: Build nixosConfiguration.demandred
      run: nix run .#ncf -- build nixos demandred --no-nom -o temp-result/demandred
    - name: Build nixosConfiguration.devcontainer
      run: nix run .#ncf -- build nixos devcontainer --no-nom -o temp-result/devcontainer
    - name: Build nixosConfiguration.docker-on-nixos
      run: nix run .#ncf -- build nixos docker-on-nixos --no-nom -o temp-result/docker-on-nixos
    - name: Build nixosConfiguration.forgejo
      run: nix run .#ncf -- build nixos forgejo --no-nom -o temp-result/forgejo
    - name: Build nixosConfiguration.furfur
      run: nix run .#ncf -- build nixos furfur --no-nom -o temp-result/furfur
    - name: Build nixosConfiguration.ishamael
      run: nix run .#ncf -- build nixos ishamael --no-nom -o temp-result/ishamael
    - name: Build nixosConfiguration.iso
      run: nix run .#ncf -- build nixos iso --no-nom -o temp-result/iso
    - name: Build nixosConfiguration.mail
      run: nix run .#ncf -- build nixos mail --no-nom -o temp-result/mail
    - name: Build nixosConfiguration.media
      run: nix run .#ncf -- build nixos media --no-nom -o temp-result/media
    - name: Build nixosConfiguration.monitor
      run: nix run .#ncf -- build nixos monitor --no-nom -o temp-result/monitor
    - name: Build nixosConfiguration.nix-cache
      run: nix run .#ncf -- build nixos nix-cache --no-nom -o temp-result/nix-cache
    - name: Build nixosConfiguration.qdevice
      run: nix run .#ncf -- build nixos qdevice --no-nom -o temp-result/qdevice
    - name: Run flake check
      run: nix flake check
    - name: Clean-up old GC roots
      run: rm -rf "$HOME/.cache/nixos-config/proposed-update/nixos-configuration"
    - name: Add nix-store GC root for nixosConfiguraion.claude-nixos-config
      run: |-
        nix-store --add-root "$HOME/.cache/nixos-config/proposed-update/nixos-configuration/claude-nixos-config" \
          -r "$(readlink -f "temp-result/claude-nixos-config")"
    - name: Add nix-store GC root for nixosConfiguraion.demandred
      run: |-
        nix-store --add-root "$HOME/.cache/nixos-config/proposed-update/nixos-configuration/demandred" \
          -r "$(readlink -f "temp-result/demandred")"
    - name: Add nix-store GC root for nixosConfiguraion.devcontainer
      run: |-
        nix-store --add-root "$HOME/.cache/nixos-config/proposed-update/nixos-configuration/devcontainer" \
          -r "$(readlink -f "temp-result/devcontainer")"
    - name: Add nix-store GC root for nixosConfiguraion.docker-on-nixos
      run: |-
        nix-store --add-root "$HOME/.cache/nixos-config/proposed-update/nixos-configuration/docker-on-nixos" \
          -r "$(readlink -f "temp-result/docker-on-nixos")"
    - name: Add nix-store GC root for nixosConfiguraion.forgejo
      run: |-
        nix-store --add-root "$HOME/.cache/nixos-config/proposed-update/nixos-configuration/forgejo" \
          -r "$(readlink -f "temp-result/forgejo")"
    - name: Add nix-store GC root for nixosConfiguraion.furfur
      run: |-
        nix-store --add-root "$HOME/.cache/nixos-config/proposed-update/nixos-configuration/furfur" \
          -r "$(readlink -f "temp-result/furfur")"
    - name: Add nix-store GC root for nixosConfiguraion.ishamael
      run: |-
        nix-store --add-root "$HOME/.cache/nixos-config/proposed-update/nixos-configuration/ishamael" \
          -r "$(readlink -f "temp-result/ishamael")"
    - name: Add nix-store GC root for nixosConfiguraion.iso
      run: |-
        nix-store --add-root "$HOME/.cache/nixos-config/proposed-update/nixos-configuration/iso" \
          -r "$(readlink -f "temp-result/iso")"
    - name: Add nix-store GC root for nixosConfiguraion.mail
      run: |-
        nix-store --add-root "$HOME/.cache/nixos-config/proposed-update/nixos-configuration/mail" \
          -r "$(readlink -f "temp-result/mail")"
    - name: Add nix-store GC root for nixosConfiguraion.media
      run: |-
        nix-store --add-root "$HOME/.cache/nixos-config/proposed-update/nixos-configuration/media" \
          -r "$(readlink -f "temp-result/media")"
    - name: Add nix-store GC root for nixosConfiguraion.monitor
      run: |-
        nix-store --add-root "$HOME/.cache/nixos-config/proposed-update/nixos-configuration/monitor" \
          -r "$(readlink -f "temp-result/monitor")"
    - name: Add nix-store GC root for nixosConfiguraion.nix-cache
      run: |-
        nix-store --add-root "$HOME/.cache/nixos-config/proposed-update/nixos-configuration/nix-cache" \
          -r "$(readlink -f "temp-result/nix-cache")"
    - name: Add nix-store GC root for nixosConfiguraion.qdevice
      run: |-
        nix-store --add-root "$HOME/.cache/nixos-config/proposed-update/nixos-configuration/qdevice" \
          -r "$(readlink -f "temp-result/qdevice")"
    - name: Push to flake-bump branch
      run: git push --force origin master:flake-bump
    - name: API auth
      run: set -x; fj -H forgejo.lynx-lizard.ts.net auth logout forgejo.lynx-lizard.ts.net || true; echo "${{ secrets.PR_TOKEN }}" | fj -H forgejo.lynx-lizard.ts.net auth add-key nixos-config-bumper
    - name: Maybe create PR
      run: fj -H forgejo.lynx-lizard.ts.net pr create -r binarin/nixos-config --base master --head flake-bump --body "Bump flake inputs" "Bump everything" || true
