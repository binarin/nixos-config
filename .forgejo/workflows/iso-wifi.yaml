# auto-generated via: nix run .#ci-template-generator
jobs:
  build-iso-wifi:
    if: github.ref == 'refs/heads/master'
    runs-on: native
    steps:
    - uses: actions/checkout@v4
      with:
        ref: master
    - env:
        GIT_CRYPT_KEY: ${{ secrets.GIT_CRYPT_KEY }}
      name: unlock git-crypt
      run: |
        git crypt unlock <(echo "$GIT_CRYPT_KEY"|base64 -d)
    - name: Build ISO image
      run: |
        nix build "$(pwd)#nixosConfigurations.iso.config.system.build.isoImage" \
          -j auto \
          -o iso-result
    - name: Inject WiFi credentials and create GC root
      run: |
        set -euo pipefail

        # Read WiFi password from git-crypt decrypted file
        WIFI_PASSWORD=$(cat files/agares-guest.git-crypt)

        # Find the ISO file
        ISO_FILE=$(find iso-result -name "*.iso" | head -1)

        # Prepare output directory
        OUTPUT_DIR="$HOME/.cache/nixos-config/master/iso-wifi"
        mkdir -p "$OUTPUT_DIR"

        # Run injection script
        ./scripts/inject-iso-wifi.sh "$ISO_FILE" "agares-guest" "$WIFI_PASSWORD" "$OUTPUT_DIR/nixos-wifi.iso"

        echo "WiFi-enabled ISO created at: $OUTPUT_DIR/nixos-wifi.iso"
on:
  workflow_dispatch: {}
